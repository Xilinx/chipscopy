# This workflow publishes documentation to GitHub Pages
#
# Structure:
# - Trigger: Manual dispatch (for releases) or PR events (for preview)
# - Job 1 (build-and-publish-docs): Builds Sphinx docs and commits to gh-pages branch
#   - Releases go to root (e.g., 2025.1/), PRs go to tmp/PR-{number}/
# - Job 2 (cleanup-pr-docs): Removes PR docs when PR is closed
# - Job 3 (deploy): Deploys the gh-pages branch to GitHub Pages

name: Publish Docs to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      release-name:
        description: "Release name (e.g., 2025.1)"
        required: true
        type: string
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - master

permissions:
  contents: write

jobs:
  build-and-publish-docs:
    name: Build and Publish Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    outputs:
      release-name: ${{ steps.determine-release.outputs.release-name }}
      target-path: ${{ steps.determine-release.outputs.target-path }}

    steps:
      - name: Determine release name and target path
        id: determine-release
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            RELEASE_NAME="${{ github.event.inputs.release-name }}"
            TARGET_PATH="$RELEASE_NAME"
          else
            # For pull_request, use PR number and put in tmp folder
            RELEASE_NAME="PR-${{ github.event.pull_request.number }}"
            TARGET_PATH="tmp/$RELEASE_NAME"
          fi
          echo "release-name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "target-path=$TARGET_PATH" >> $GITHUB_OUTPUT
          echo "::notice::Release name: $RELEASE_NAME"
          echo "::notice::Target path: $TARGET_PATH"

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Set up Poetry
        uses: abatilo/actions-poetry@v3
        with:
          # TODO - Read this from .poetry-version file
          poetry-version: 1.8.3

      # TODO - Once the poetry.lock file is available in the repo, we can simply run `poetry install`
      - name: Install documentation dependencies
        run: |
          cat > requirements.txt << 'EOF'
          alabaster==0.7.13 ; python_full_version >= "3.8.3" and python_version < "4.0"
          antlr4-python3-runtime==4.13.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          babel==2.12.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          certifi==2023.7.22 ; python_full_version >= "3.8.3" and python_version < "4.0"
          charset-normalizer==3.2.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          click==8.1.7 ; python_full_version >= "3.8.3" and python_version < "4.0"
          colorama==0.4.6 ; python_full_version >= "3.8.3" and python_version < "4.0" and (sys_platform == "win32" or platform_system == "Windows")
          commonmark==0.9.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          docutils==0.19 ; python_full_version >= "3.8.3" and python_version < "4.0"
          idna==3.4 ; python_full_version >= "3.8.3" and python_version < "4.0"
          imagesize==1.4.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          importlib-metadata==6.8.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          jinja2==3.1.2 ; python_full_version >= "3.8.3" and python_version < "4.0"
          loguru==0.7.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          markdown-it-py==3.0.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          markdown==3.4.4 ; python_full_version >= "3.8.3" and python_version < "4.0"
          markupsafe==2.1.3 ; python_full_version >= "3.8.3" and python_version < "4.0"
          mdurl==0.1.2 ; python_full_version >= "3.8.3" and python_version < "4.0"
          more-itertools==10.1.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          packaging==23.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          pillow==10.4.0 ; python_full_version >= "3.8.3" and python_version < "4"
          pygments==2.16.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          pytz==2023.3.post1 ; python_full_version >= "3.8.3" and python_version < "3.9"
          pyyaml==6.0.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          recommonmark==0.6.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          reportlab==4.0.4 ; python_full_version >= "3.8.3" and python_version < "4"
          requests==2.29.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          rich==13.5.2 ; python_full_version >= "3.8.3" and python_version < "4.0"
          rst2pdf==0.99 ; python_full_version >= "3.8.3" and python_version < "4.0"
          smartypants==2.0.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          snowballstemmer==2.2.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinx-autodoc-typehints==1.12.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinx-markdown-tables==0.0.17 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinx-rtd-theme==2.0.0 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinx==6.2.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-applehelp==1.0.4 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-devhelp==1.0.2 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-htmlhelp==2.0.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-jquery==4.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-jsmath==1.0.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-qthelp==1.0.3 ; python_full_version >= "3.8.3" and python_version < "4.0"
          sphinxcontrib-serializinghtml==1.1.5 ; python_full_version >= "3.8.3" and python_version < "4.0"
          typing-extensions==4.7.1 ; python_full_version >= "3.8.3" and python_version < "4.0"
          urllib3==1.26.19 ; python_full_version >= "3.8.3" and python_version < "4.0"
          win32-setctime==1.1.0 ; python_full_version >= "3.8.3" and python_version < "4.0" and sys_platform == "win32"
          zipp==3.16.2 ; python_full_version >= "3.8.3" and python_version < "4.0"
          EOF
          poetry run pip install -r requirements.txt

      - name: Build documentation
        run: |
          cd docs
          poetry run make html

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v5
        with:
          name: docs-build
          path: docs/_build/html/

      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages
          path: gh-pages

      - name: Remove existing folder if exists
        run: |
          if [ -d "gh-pages/${{ steps.determine-release.outputs.target-path }}" ]; then
            echo "Removing existing folder: ${{ steps.determine-release.outputs.target-path }}"
            rm -rf "gh-pages/${{ steps.determine-release.outputs.target-path }}"
          else
            echo "No existing folder found for: ${{ steps.determine-release.outputs.target-path }}"
          fi

      - name: Create target folder
        run: |
          mkdir -p "gh-pages/${{ steps.determine-release.outputs.target-path }}"
          echo "Created folder: ${{ steps.determine-release.outputs.target-path }}"

      - name: Download and copy built documentation
        uses: actions/download-artifact@v5
        with:
          name: docs-build
          path: docs-build-temp

      - name: Copy documentation files to target folder
        run: |
          cp -r docs-build-temp/. "gh-pages/${{ steps.determine-release.outputs.target-path }}/"
          echo "Documentation copied to ${{ steps.determine-release.outputs.target-path }}"

      - name: Commit and push changes
        run: |
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="Publish documentation for: ${{ steps.determine-release.outputs.release-name }}"
            if [[ "${{ github.event_name }}" == "pull_request" ]]; then
              COMMIT_MSG="$COMMIT_MSG (PR #${{ github.event.pull_request.number }})"
            fi
            git commit -m "$COMMIT_MSG"
            git push origin gh-pages
            echo "Documentation published successfully to ${{ steps.determine-release.outputs.target-path }}!"
          fi

  cleanup-pr-docs:
    name: Cleanup PR docs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages

      - name: Remove PR documentation folder
        run: |
          PR_FOLDER="tmp/PR-${{ github.event.pull_request.number }}"
          if [ -d "$PR_FOLDER" ]; then
            echo "Removing PR documentation folder: $PR_FOLDER"
            rm -rf "$PR_FOLDER"
          else
            echo "No documentation folder found for PR #${{ github.event.pull_request.number }}"
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Remove documentation for closed PR #${{ github.event.pull_request.number }}"
            git push origin gh-pages
            echo "PR documentation cleaned up successfully!"
          fi

            # Single deploy job since we're just deploying

  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build-and-publish-docs, cleanup-pr-docs]

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout the gh-pages branch
        uses: actions/checkout@v5
        with:
          ref: gh-pages

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
